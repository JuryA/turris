name: $(Date:yyyyMMdd)
trigger:
  branches:
    include:
    - master
  paths:
    include:
    - toolchain/turris-base/*
pr:
  autoCancel: true
  branches:
    include:
    - master
  paths:
    include:
    - toolchain/turris-base/*

pool: Default

stages:
- stage: toolchain_turris_base  
  displayName: base docker image for toolchain based on turris-build 
  jobs:


  # Build base image for turris-build based toolchain images
  - job: toolchain_turris_base
    displayName: docker image for turris-build base (build and push to dockerhub)
    strategy:
      matrix:
        omnia-stable:
          device: omnia
          tag: stable
        omnia-latest:
          device: omnia
          tag: latest
    timeoutInMinutes: 240
    steps: # [ script | bash | pwsh | powershell | checkout | task | templateReference ]
    # Login to docker.io container registry
    - task: Docker@2
      name: docker_login
      displayName: login to dockerhub
      inputs:
        command: login
        containerRegistry: dockerhub-sel-wtf

    # Build Docker image with name: selwtf/build-turris-base:${turris_device}-${turris_os_tag}
    - task: Docker@2
      name: docker_build
      displayName: build docker image
      inputs:
        command: build
        Dockerfile: toolchain/turris-base/dockerfile
        buildContext: toolchain/turris-base
        arguments: --build-arg DEVICE=$(device) --build-arg TAG=$(tag)
        repository: selwtf/build-turris-base
        tags: |
          $(device)-$(tag)

    # Push Docker image to dockerhub (docker.io/selwtf/<name>:<tag>)
    - task: Docker@2
      name: docker_push
      displayName: push docker image
      inputs:
        command: push
        repository: selwtf/build-turris-base
        tags: |
          $(device)-$(tag)

